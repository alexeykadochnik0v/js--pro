# Практика к уроку 24 — собственный API

Материал для вебинара по [уроку 24](https://github.com/JavaScript-Basic-OTUS/js--pro/blob/main/lessons/lesson24/lesson.md). Все примеры из урока реализованы в этом репозитории на **TypeScript**.

---

## Что уже сделано в проекте

- [x] Express-сервер и структура (routes → controllers → services)
- [x] CRUD для ресурса `tasks` (GET, POST, PATCH, DELETE)
- [x] Единый формат ответов (`success` / `error`)
- [x] Валидация входных данных в контроллере
- [x] Middleware обработки ошибок (в т.ч. невалидный JSON)
- [x] Расширения из урока: фильтр `?completed=`, поиск `?search=`, `HEAD /api/tasks/:id`

В Express 5 async-обёртка не нужна: отклонённые промисы из обработчиков автоматически попадают в error middleware.

---

## Задания для практики

### 1. Запуск и проверка CRUD

1. Запустите сервер: `npm run dev`.
2. Выполните по очереди запросы из README (curl или Postman/Thunder Client).
3. Убедитесь, что ответы в формате `{ success, data, error }` и статусы корректны (200, 201, 204, 400, 404).

### 2. Валидация

- Отправьте `POST /api/tasks` с телом `{}` или `{"title": ""}` — должен быть `400` и сообщение про title.
- Отправьте `PATCH /api/tasks/1` с `{"completed": "yes"}` — должен быть `400` (completed должен быть boolean).

### 3. Обработка ошибок

- Отправьте `POST /api/tasks` с телом `not json` и заголовком `Content-Type: application/json` — должен быть `400` с сообщением про Invalid JSON.

### 4. Расширения API (уже в коде — разобрать)

- `GET /api/tasks?completed=true` — только выполненные.
- `GET /api/tasks?search=express` — задачи, в title которых есть подстрока (без учёта регистра).
- `HEAD /api/tasks/:id` — только статус 200 или 404, без тела.

### 5. Самостоятельно: лимит длины title

- В контроллере `create` и `update` добавьте проверку: `title` не длиннее 200 символов. При нарушении — `400` и сообщение вида `Title too long (max 200)`.

### 6. Самостоятельно: сортировка

- Добавьте query-параметр `sort=createdAt` для `GET /api/tasks`. При `sort=createdAt` возвращать задачи, отсортированные по `createdAt` (можно по возрастанию). Остальные значения `sort` игнорировать или отдавать 400.

---

## Типичные ошибки (из урока)

| Ошибка | Как правильно |
|--------|----------------|
| Всегда возвращать 200 | Для «не найдено» — 404, для ошибок валидации — 400 |
| Не делать `return` после `res.status(400).json(...)` | Всегда `return res.status(...).json(...)`, иначе возможна отправка ответа дважды |
| Использовать PUT для частичного обновления | PUT — полная замена ресурса; для частичного обновления — PATCH |
| Без валидации принимать `req.body` | Проверять тип и наличие обязательных полей, длину и т.д. |
| Вся логика в роуте | Роут → контроллер → сервис; БД/логика только в сервисе |

---

## Полезные ссылки

- [Express.js](https://expressjs.com/)
- [HTTP Status Codes (MDN)](https://developer.mozilla.org/en-US/docs/Web/HTTP/Status)
- [REST API Best Practices](https://restfulapi.net/)
